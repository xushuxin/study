#### 从输入URL地址到看到页面，中间都经历的啥？

面试回答：

##### 第一步：URL解析

+ **地址解析：**

  ![image-20201229130840619](/Users/xushuxin/Library/Application Support/typora-user-images/image-20201229130840619.png)

  + 传输协议：http、https、ftp

  + 登录信息认证：user:pass 不常用

  + 域名：服务器地址

  + 端口：对应的服务(0~65535之间)

    默认端口号http: 80  http: 443  ftp: 21

  + 请求资源的文件路径(可能存在重写重定向)

  + 查询字符串：问号参数

  + 片段标识符：HASH值

+ **编码**

  encodeURI/decodeURI：用于对完整的URL编码，处理空格和中文字符

  encodeURIComponent/decodeURIComponent：用于对传递的参数编码

  escape（前端有这个方法，不是所有后端语言都支持unescape）

  URI 、URL、URN的区别

  URI：统一资源标识符（我们平常说的URL其实是指它）

  URL：统一资源定位符（包括协议到资源文件地址的部分）

  URN：统一资源名称（不包括协议，包括域名到HASH的部分）

##### 第二步：缓存检查(产品性能优化的重点)

+ 先检测是否存在强缓存

+ 有且未失效，走强缓存
+ 没有或者失效，检测是否有协商缓存
+ 有协商缓存，走协商缓存
+ 没有则重新请求数据

**缓存位置：**

+ Memory Cache：内存缓存
+ Disk Cache：硬盘缓存

打开网页：查找硬盘缓存中是否有匹配，如有则使用，没有则发送网络请求

普通刷新（F5）：因为当前页签没有关闭，内存缓存是可用的，会被优先使用，其次才使用硬盘缓存

强制刷新（Ctrl + F5）：浏览器不使用缓存，因此发送的请求头部均带有Cache-Control:no-cache，服务器直接返回200和最新内容

**强缓存 Expires / Cache-Control**

浏览器对于强缓存的处理：根据第一次请求资源时返回的响应头来确定的

+ Expires: 缓存过期时间，用来指定资源到期的时间（HTTP/1.0）
+ Cache-Control:  max-age设置第一次拿到资源后的一段时间内，再次发送请求时从缓存中读取信息（HTTP/1.1）
+ 两者同时存在的话，Cache-Control的优先级高于Expires

**协商缓存 last-modified /Etag**

协商缓存是强缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程

**协商缓存和强缓存的区别：**

协商缓存总会和服务器协商，所以一定会要发HTTP请求，而强缓存只要缓存没失效就不需要重新发请求

##### 第三步DNS解析

1.浏览器DNS缓存2.本地DNS缓存 3.本地hosts文件映射4.路由器DNS缓存5.到互联网服务提供商(ISP)的DNS服务器查询 6.根服务器递归查询

第一次dns解析事件预计在20~120毫秒

优化：

+ 减少DNS请求次数
+ DNS预获取（DNS Prefetch）

##### 第四步：TCP三次握手

##### 第五步：数据传输

##### 第六步：TCP四次挥手

##### 第七步：页面渲染

---------------------------------



浏览器是多进程的，整体上包括：浏览器进程、渲染进程、网络进程、GPU进程、插件进程

进程之间可以通过ipc进行通信

##### 进程方面：

- 用户输入url地址，浏览器进程会开始导航，如果输入的是关键字，会将关键字根据默认的搜索引擎生成地址

- 浏览器进程 会准备一个渲染进程用于渲染页面
- 网络进程加载资源，最终将加载的资源交给渲染进程来处理
- 最后渲染完毕显示

##### 网络七层模型（物数网传会表应）

+ 物理层（建立、维护、断开物理连接）

+ 数据链路层（建立逻辑连接、硬件寻址、差错校验）

+ 网络层（ip）进行逻辑地址寻址，实现不同网络之间的路径选择

  协议有：**ICMP IGMP IP（IPV4 IPV6）**

+ 传输层（TCP 安全可靠 分段传输，UDP高效，容易丢包）

  协议：**TCP UDP**

+ 会话层（建立、管理、终止会话）

+ 表示层（数据的表示、安全、压缩）

+ 应用层（网络服务与最终用户的一个接口）

  协议：**HTTP FTP TFTP SMTP SNMP DNS TELNET HTTPS POP3 DHCP**

五层模型把会话层、表示层、应用层合并为应用层

在[TCP/IP](https://baike.baidu.com/item/TCP%2FIP%E5%8D%8F%E8%AE%AE/212915?fromtitle=tcp%2Fip&fromid=214077&fr=aladdin#reference-[3]-7649-wrap)协议中，它们被简化为了四个层次：应用层（应用层、表示层、会话层）、传输层、网络层、网络接口层（物理层、数据链路层）

应用层之间的协议（比如HTTP）通过逐级调用传输层（TCP）、网络层（比如IPV4）、和物理数据链路层，从而可以实现应用层的应用程序的通信。

+ 第一步：URL解析

+ 第二步：缓存检查，有强缓存走强缓存，没有强缓存，则看是否有协商缓存，有协商缓存走协商缓存，没有则重新请求数据

+ 第三步：通过DNS解析域名查找ip地址（DNS 基于UDP），如果有DNS缓存，直接获取缓存中的ip地址（host + port）（1.浏览器DNS缓存2.本地DNS缓存 3.本地hosts文件映射4.路由器DNS缓存5.到互联网服务提供商(ISP)的DNS服务器查询 6.根服务器递归查询）

+ 第四步：发起TCP三次握手，建立TCP连接，用于传输

+ 第五步：发送http请求（包含请求行 请求头 请求体）

+ 第六步：数据传输

  将数据拆分成数据包，有序的传输（如果丢包，有重发机制），服务器会按照顺序接收数据

+ 第七步：服务器响应数据（响应行 响应头 响应体）

  服务器返回 301 302会进行重定向操作；返回304会去查询浏览器缓存进行返回

+ 第八步：TCP四次挥手，关闭连接

  http/1.1不会立即关闭，会默认开启keep-alive

+ 第九步：浏览器渲染页面

  + 解析HTML，构建DOM树，并且下载解析相关资源文件

  + CSS资源下载完成后，解析CSS样式表，构建CSSOM树

  + 将DOM树和CSSOM树合并成一个渲染树

  + 根据渲染树布局，计算每个节点在页面坐标系中的大小和位置

  + 最后调用GPU绘制，合成图层，显示在屏幕上

**涉及到的一些知识点：**

SSL连接的作用：认证用户服务器，确保发送到正确的服务器；加密数据防窃取；维护数据的完整性

首先进行的是DOM解析，解析过程中会遇到js，css，图片，音视频等资源。

+ 遇到link外部css，创建线程加载，并继续解析文档

+ 遇到img等外部资源，创建线程加载，异步加载src，继续解析文档

+ 遇到script外部js，并没有设置async、defer，会阻塞文档解析，加载并执行完js后，继续解析文档

+ 遇到script外部js，设置了async属性，浏览创建线程加载，并继续解析文档，js加载完成后，阻塞文档解析，执行js代码后，继续解析文档

+ 遇到script外部js，设置了defer属性，浏览器创建线程加载，并继续解析文档，文档解析完成之后再，顺序执行所有设置了defer的脚本

+ 所有异步脚本执行完成并且img等资源加载完成之后，触发window.onload事件

  **html，css，js资源之间加载及阻塞关系：**

+ 加载除js之外的资源外不会阻塞DOM解析（浏览器会处理开启多进程，chrome会开启5个进程）

+ 如果没有开启异步加载脚本，加载和执行js代码都会阻塞DOM解析

+ css加载不会阻塞js的加载，但是css会阻塞js的执行（间接阻塞了js后面的DOM解析）

+ 解析构建DOM树和CSS树的按照深度优先原则